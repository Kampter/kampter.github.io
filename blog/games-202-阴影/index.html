<!doctype html><html lang=en><head><title>Games 202 - 阴影</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=HandheldFriendly content="true"><meta name=author content="bslthemes"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.8.0/css/all.css><link rel=stylesheet href=https://kampter.github.io/scss/style.min.css><link rel=stylesheet href=https://kampter.github.io/plugins/ionicons/ionicons.css><link rel=stylesheet href=https://kampter.github.io/plugins/font-awesome/css/font-awesome.css><link rel=stylesheet href=https://kampter.github.io/plugins/magnific-popup/magnific-popup.css><link rel=stylesheet href=https://kampter.github.io/plugins/owl-carousel/owl.carousel.css><link rel=stylesheet href=https://kampter.github.io/plugins/animate/animate.css><link rel=stylesheet href=https://kampter.github.io/plugins/syntax/syntax.css><link rel="shortcut icon" href=https://kampter.github.io/images/favicon/favicon.ico type=image/x-icon><link rel=icon href=https://kampter.github.io/images/favicon/favicon.ico type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-4BGKQYLBBG"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4BGKQYLBBG")</script></head><body class=blog><div class="page new-skin"><div class=preloader><div class="centrize full-width"><div class=vertical-center><div class=spinner><div class=double-bounce1></div><div class=double-bounce2></div></div></div></div></div><div class="background gradient"><ul class=bg-bubbles><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul></div><div class=s_overlay></div><div class=content-sidebar><div class=sidebar-wrap><aside id=secondary class=widget-area><div id=search class="widget widget_search"><form class=search-form action=https://kampter.github.io/search><label><input type=search id=searchInput class=search-field placeholder="Search ..."></label>
<input type=submit class=search-submit><ul id=searchResults></ul></form></div><section class="widget widget_menu"><h2 class=widget-title>Menu</h2><ul><li class=active><a href=https://kampter.github.io//blog>Blog Page</a></li><li><a href=https://kampter.github.io//portfolio>Portfolio Page</a></li></ul></section><section class="widget widget_recent_entries"><h2 class=widget-title>Latest Posts</h2><ul><li><a href=https://kampter.github.io/blog/%E8%BF%91%E6%9C%9F%E5%81%9A%E7%9A%84%E5%87%A0%E4%B8%AAunity%E5%92%8Cue%E7%89%B9%E6%95%88/>近期做的几个Unity和UE特效</a></li><li><a href=https://kampter.github.io/blog/urp%E5%B1%8F%E5%B9%95%E7%A9%BA%E9%97%B4sobel%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B/>URP屏幕空间Sobel边缘检测</a></li><li><a href=https://kampter.github.io/blog/blender%E6%8F%92%E4%BB%B6%E5%88%B6%E4%BD%9C%E5%BF%83%E5%BE%97/>Blender插件制作心得</a></li><li><a href=https://kampter.github.io/blog/urp%E5%B1%8F%E5%B9%95%E7%A9%BA%E9%97%B4%E7%8E%AF%E5%A2%83%E5%85%89%E9%81%AE%E8%94%BD/>URP屏幕空间环境光遮蔽</a></li></ul></section><section class="widget widget_categories"><h2 class=widget-title>Categories</h2><ul><li><a href=https://kampter.github.io/categories/portfolio/>Portfolio</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>学习笔记</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/categories/%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/>技术实现</a>
<small>( 9 )</small></li><li><a href=https://kampter.github.io/categories/%E6%97%A5%E5%B8%B8%E7%94%9F%E6%B4%BB/>日常生活</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>课程笔记</a>
<small>( 9 )</small></li></ul></section><section class="widget widget_tags"><h2 class=widget-title>Tags</h2><ul><li><a href=https://kampter.github.io/tags/after-effect/>After Effect</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/bifrost/>Bifrost</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/blender/>blender</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/c#/>C#</a>
<small>( 4 )</small></li><li><a href=https://kampter.github.io/tags/computer-graphic/>Computer Graphic</a>
<small>( 9 )</small></li><li><a href=https://kampter.github.io/tags/eve-online/>Eve Online</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/flip/>Flip</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/games-101/>Games 101</a>
<small>( 4 )</small></li><li><a href=https://kampter.github.io/tags/games-202/>Games 202</a>
<small>( 3 )</small></li><li><a href=https://kampter.github.io/tags/hlsl/>HLSL</a>
<small>( 11 )</small></li><li><a href=https://kampter.github.io/tags/houdini/>Houdini</a>
<small>( 3 )</small></li><li><a href=https://kampter.github.io/tags/java/>Java</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/math/>Math</a>
<small>( 8 )</small></li><li><a href=https://kampter.github.io/tags/maya/>Maya</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/niagara-system/>Niagara System</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/opengl/>Opengl</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/particle/>Particle</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/pbr-shading/>PBR Shading</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/tags/plugin/>plugin</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/profiling/>Profiling</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/render-feature/>Render Feature</a>
<small>( 4 )</small></li><li><a href=https://kampter.github.io/tags/shader-graph/>Shader Graph</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/substance-designer/>Substance Designer</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/toon-shading/>Toon Shading</a>
<small>( 3 )</small></li><li><a href=https://kampter.github.io/tags/unity/>Unity</a>
<small>( 12 )</small></li><li><a href=https://kampter.github.io/tags/unreal-engine/>Unreal Engine</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/upr/>UPR</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/vfx-graph/>VFX graph</a>
<small>( 1 )</small></li></ul></section></aside></div><span class=close></span></div><div class="container opened" data-animation-in=fadeInLeft data-animation-out=fadeOutLeft><header class=header><a href=# class=menu-btn><span></span></a><div class=top-menu><ul><li class=active><a href=https://kampter.github.io/#about-card><span class="icon ion-person"></span>
<span class=link>About</span></a></li><li><a href=https://kampter.github.io/#resume-card><span class="icon ion-android-list"></span>
<span class=link>Resume</span></a></li><li><a href=https://kampter.github.io/#works-card><span class="icon ion-paintbrush"></span>
<span class=link>Works</span></a></li><li><a href=https://kampter.github.io/#blog-card><span class="icon ion-chatbox-working"></span>
<span class=link>Blog</span></a></li><li><a href=https://kampter.github.io/#contact-card><span class="icon ion-at"></span>
<span class=link>Contact</span></a></li></ul></div></header><div class=card-started id=home-card><div class="profile no-photo"><div class=slide style=background-image:url(https://kampter.github.io/images/1082264.png)></div><div class=title>王子正</div><div class="subtitle subtitle-typed"><div class=typing-title><p>Technical Artist</p></div></div><div class=social><a target=_blank href=https://twitter.com/wang_psbswsg title=Twitter><span class="fab fa-twitter"></span></a>
<a target=_blank href=https://github.com/Kampter title=GitHub><span class="fab fa-github"></span></a>
<a target=_blank href=https://www.youtube.com/channel/UCK43eUkmsyRk8FeBw5oRJtQ title=Youtube><span class="fab fa-youtube"></span></a>
<a target=_blank href=https://www.artstation.com/kampter title=Stackoverflow><span class="fab fa-artstation"></span></a></div><div class=lnks><a href=/images/Resume_ZizhengWang_Chinese_v004.pdf target=_blank class=lnk><span class=text>Download CV</span>
<span class="ion ion ion-archive"></span></a>
<a href=mailto:psbswsg@gmail.com target=_blank class=lnk><span class=text>Contact Me</span>
<span class="ion arrow"></span></a></div></div></div><div class="card-inner blog blog-post animated" id=blog-card><div class=card-wrap><div class="content blog-single"><div class=title>Blog Post</div><div class="row border-line-v"><div class="col col-m-12 col-t-12 col-d-12"><div class=post-box><h1>Games 202 - 阴影</h1><div class=blog-detail><span class=date>January 11, 2023</span>
<span class=cat-links><a href=https://kampter.github.io/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>课程笔记</a></span>
<span class=byline>By <span class=author>Ryan Adlard</span></span></div><div class=blog-image><img src=https://kampter.github.io/images/blog/shadows.jpg alt="Games 202 - 阴影"></div><div class=blog-content><h2 id=shadowmapping>ShadowMapping</h2><h3 id=原理>原理</h3><figure><img src=image-20230223123016702.png width=50%></figure><ol><li>先渲染一个从光源到物体的pass 获得深度图</li><li>再渲染一个从相机位置到物体的pass获得深度图，并且把这个深度投影到光源位置 （图中橙色点为无阴影）</li></ol><figure><img src=image-20230223123254908.png width=50%></figure><ol start=3><li>比较第一次与第二次投影到光源的深度，如果相同即没有阴影；如果比原深度远，即在阴影中(图中红色点为在阴影中)</li></ol><h3 id=缺陷>缺陷</h3><ul><li>走样、分辨率。数值精度问题</li><li>只能点光源、硬阴影</li><li>会产生自遮挡如果light 方向与物体平面接近平行</li></ul><figure><img src=image-20230223124101790.png width=50%></figure><ul><li>改善方式具体方式就是当一个点深度大于记录深度的值超过一个阈值bias时，我们才认为这个点在阴影内。</li></ul><h4 id=解决方案>解决方案</h4><ul><li><p>增加一个 bias</p></li><li><p>中间的黄色那段我们不算</p><ul><li>也就是说我们对计算得到的深度减去一个 bias</li></ul><figure><img src=image-20210407161249651.png width=50%></figure></li><li><p>一些技巧：动态的 bias</p><ul><li>当光线和物体表面法线夹角比较大时，bias 也需要比较大</li><li>当光线和物体表面法线夹角比较小时，bias 比较小即可</li></ul></li><li><p>不合适的bias会出现阴影与物体中间出现间隔</p></li></ul><p>&mdash; 2022.12.15 更新 &mdash;</p><p>Shadow map已经又引擎自动计算好不需要手动实现。</p><p>URP中对shadow map 采样。</p><p>其中开启阴影投射和接收的关键字为:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span>pragma multi_compile _ _MAIN_LIGHT_SHADOWS
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span>pragma multi_compile _ _MAIN_LIGHT_SHADOWS_CASCADE
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span>pragma multi_compile _ _SHADOWS_SOFT
</span></span></code></pre></div><p>在计算Light的时候，遍历每个光源的light.shadowattenuation加算到diffuse color中就可以计算出阴影颜色。而完整的阴影投射在URP中需要单独在shadowCaster这个pass中计算，同时调用ApplyShadowBia()来计算上文中提到的bias解决方案。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span>Shader <span style=color:#e6db74>&#34;Custom/ShadowReciver&#34;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Properties
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _BaseColor (<span style=color:#e6db74>&#34;Base Color&#34;</span>, Color) <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>)
</span></span><span style=display:flex><span>        _BaseMap (<span style=color:#e6db74>&#34;Main Texture&#34;</span>, <span style=color:#ae81ff>2</span>D) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;white&#34;</span>{}
</span></span><span style=display:flex><span>        _SpecColor (<span style=color:#e6db74>&#34;Specular Color&#34;</span>, Color) <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>)
</span></span><span style=display:flex><span>        _Smoothness (<span style=color:#e6db74>&#34;Gloss&#34;</span>, range(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>256</span>)) <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>        _BumpMap (<span style=color:#e6db74>&#34;Normal Map&#34;</span>, <span style=color:#ae81ff>2</span>D) <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bump&#34;</span> {}
</span></span><span style=display:flex><span>        _BumpScale (<span style=color:#e6db74>&#34;Scale&#34;</span>, Float) <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span>        [Toggle(_MULTIPLE_LIGHTS)] _MultipleLights (<span style=color:#e6db74>&#34;Received MultipleLights&#34;</span>, Float) <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    SubShader
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Tags {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;RenderType&#34;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Opaque&#34;</span> 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;RenderPipeline&#34;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UniversalRenderPipeline&#34;</span> 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;LightMode&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;UniversalForward&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;ShaderModel&#34;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;4.5&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        HLSLINCLUDE
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span>include <span style=color:#e6db74>&#34;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>#</span>include <span style=color:#e6db74>&#34;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        CBUFFER_START(UnityPerMaterial)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> _BaseMap_ST;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> _BumpMap_ST;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> _BaseColor;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> _SpecColor;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half</span> _Smoothness;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half</span> _BumpScale;
</span></span><span style=display:flex><span>        CBUFFER_END
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        TEXTURE2D(_BaseMap);    SAMPLER(sampler_BaseMap);
</span></span><span style=display:flex><span>        TEXTURE2D(_BumpMap);    SAMPLER(sampler_BumpMap);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> Attributes
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> positionOS <span style=color:#f92672>:</span> POSITION;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> normal <span style=color:#f92672>:</span> NORMAL;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> tangetOS <span style=color:#f92672>:</span> TANGENT;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half2</span> uv <span style=color:#f92672>:</span> TEXCOORD0;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> Varyings
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> positionCS <span style=color:#f92672>:</span> SV_POSITION;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> positionWS <span style=color:#f92672>:</span> POSITION_WS;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> positionSC <span style=color:#f92672>:</span> POSITION_SC;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half2</span> uv <span style=color:#f92672>:</span> TEXCOORD0;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> normalWS <span style=color:#f92672>:</span> NORMAL_WS;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> tangentWS <span style=color:#f92672>:</span> TANGENT_WS;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>half4</span> LightingModelImplement (Light light, <span style=color:#66d9ef>half3</span> normalWS, <span style=color:#66d9ef>half3</span> viewDirWS, <span style=color:#66d9ef>half2</span> uv, <span style=color:#66d9ef>bool</span> isMainLight)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> lightColor <span style=color:#f92672>=</span> light.color;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> lightDir <span style=color:#f92672>=</span> normalize(light.direction);
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half</span> lambert <span style=color:#f92672>=</span> saturate(dot(lightDir, normalWS));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> albedo <span style=color:#f92672>=</span> SAMPLE_TEXTURE2D(_BaseMap, sampler_BaseMap, uv) <span style=color:#f92672>*</span> _BaseColor;
</span></span><span style=display:flex><span>            <span style=color:#75715e>//half3 ambient = half3(unity_SHAr.w, unity_SHAg.w, unity_SHAb.w) * albedo;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> ambient <span style=color:#f92672>=</span> SampleSH(normalWS) <span style=color:#f92672>*</span> albedo;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> diffuse <span style=color:#f92672>=</span> lambert <span style=color:#f92672>*</span> lightColor <span style=color:#f92672>*</span> ambient;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> halfDir <span style=color:#f92672>=</span> normalize(viewDirWS <span style=color:#f92672>+</span> lightDir);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half3</span> specular <span style=color:#f92672>=</span> pow(saturate(dot(normalWS, halfDir)), _Smoothness) <span style=color:#f92672>*</span> lightColor <span style=color:#f92672>*</span> saturate(_SpecColor);
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> finalColor <span style=color:#f92672>=</span> <span style=color:#66d9ef>half4</span>(ambient <span style=color:#f92672>+</span> diffuse <span style=color:#f92672>+</span> specular, <span style=color:#ae81ff>1.0</span>) <span style=color:#f92672>*</span> light.shadowAttenuation <span style=color:#f92672>*</span> light.distanceAttenuation;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> finalColor;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        ENDHLSL
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        Pass
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Tags{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;LightMode&#34;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UniversalForward&#34;</span>    
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            HLSLPROGRAM
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span>pragma vertex vert
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span>pragma fragment frag
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span>pragma shader_feature _MULTIPLE_LIGHTS
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span>pragma multi_compile _ _MAIN_LIGHT_SHADOWS
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span>pragma multi_compile _ _MAIN_LIGHT_SHADOWS_CASCADE
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span>pragma multi_compile _ _SHADOWS_SOFT
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>#</span>pragma multi_compile _ _ADDITIONAL_LIGHTS_VERTEX _ADDITIONAL_LIGHTS
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            Varyings vert (Attributes IN)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> VertexPositionInputs vertex_position_inputs <span style=color:#f92672>=</span> GetVertexPositionInputs(IN.positionOS);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> VertexNormalInputs vertex_normal_inputs <span style=color:#f92672>=</span> GetVertexNormalInputs(IN.normal);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// get positive or negative normal signal (should be either 1 or -1)</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>half</span> sign <span style=color:#f92672>=</span> IN.tangetOS.w <span style=color:#f92672>*</span> GetOddNegativeScale();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                Varyings OUT;
</span></span><span style=display:flex><span>                OUT.positionWS <span style=color:#f92672>=</span> vertex_position_inputs.positionWS;
</span></span><span style=display:flex><span>                OUT.positionCS <span style=color:#f92672>=</span> vertex_position_inputs.positionCS;
</span></span><span style=display:flex><span>                OUT.normalWS <span style=color:#f92672>=</span> vertex_normal_inputs.normalWS;
</span></span><span style=display:flex><span>                OUT.positionSC <span style=color:#f92672>=</span> GetShadowCoord(vertex_position_inputs);
</span></span><span style=display:flex><span>                OUT.uv <span style=color:#f92672>=</span> TRANSFORM_TEX(IN.uv, _BaseMap);
</span></span><span style=display:flex><span>                OUT.tangentWS <span style=color:#f92672>=</span> <span style=color:#66d9ef>half4</span>(vertex_normal_inputs.tangentWS, sign);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> OUT;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>half4</span> frag (Varyings IN) <span style=color:#f92672>:</span> <span style=color:#a6e22e>SV_Target</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>half3</span> normalTS <span style=color:#f92672>=</span> UnpackNormalScale(SAMPLE_TEXTURE2D(_BumpMap, sampler_BumpMap, IN.uv), _BumpScale);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>half3</span> biTangent <span style=color:#f92672>=</span> IN.tangentWS.w <span style=color:#f92672>*</span> cross(IN.normalWS, IN.tangentWS.xyz);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>half3</span> normalWS <span style=color:#f92672>=</span> mul(normalTS, <span style=color:#66d9ef>half3x3</span>(IN.tangentWS.xyz, biTangent, IN.normalWS));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>half3</span> viewDirWS <span style=color:#f92672>=</span> SafeNormalize((GetCameraPositionWS() <span style=color:#f92672>-</span> IN.positionWS));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                Light mainLight <span style=color:#f92672>=</span> GetMainLight(IN.positionSC);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>half4</span> finalColor <span style=color:#f92672>=</span> LightingModelImplement(mainLight, normalWS, viewDirWS, IN.uv, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#66d9ef>if</span> _MULTIPLE_LIGHTS
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> lightsCount <span style=color:#f92672>=</span> GetAdditionalLightsCount();
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>; i<span style=color:#f92672>&lt;</span>lightsCount; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        Light light <span style=color:#f92672>=</span> GetAdditionalLight(i, IN.positionWS, <span style=color:#66d9ef>half4</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>                        finalColor <span style=color:#f92672>+=</span> LightingModelImplement(light, normalWS, viewDirWS, IN.uv, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>half</span> shadow <span style=color:#f92672>=</span> AdditionalLightRealtimeShadow(i, IN.positionWS, mainLight.direction);
</span></span><span style=display:flex><span>                        
</span></span><span style=display:flex><span>                        finalColor <span style=color:#f92672>*=</span> shadow;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                <span style=color:#960050;background-color:#1e0010>#</span>endif
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> finalColor;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            ENDHLSL
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>		Pass{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			Tags{
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;LightMode&#34;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ShadowCaster&#34;</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		    ZWrite On <span style=color:#75715e>// the only goal of this pass is to write depth!</span>
</span></span><span style=display:flex><span>            ZTest LEqual <span style=color:#75715e>// early exit at Early-Z stage if possible            </span>
</span></span><span style=display:flex><span>            ColorMask <span style=color:#ae81ff>0</span> <span style=color:#75715e>// we don&#39;t care about color, we just want to write depth, ColorMask 0 will save some write bandwidth</span>
</span></span><span style=display:flex><span>            Cull Back
</span></span><span style=display:flex><span>		    
</span></span><span style=display:flex><span>			HLSLPROGRAM
</span></span><span style=display:flex><span>			<span style=color:#960050;background-color:#1e0010>#</span>pragma vertex vertShadow
</span></span><span style=display:flex><span>			<span style=color:#960050;background-color:#1e0010>#</span>pragma fragment fragShadow
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>half3</span> _LightDirection;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			Varyings vertShadow(Attributes IN)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>const</span> VertexPositionInputs vertex_position_inputs <span style=color:#f92672>=</span> GetVertexPositionInputs(IN.positionOS);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> VertexNormalInputs vertex_normal_inputs <span style=color:#f92672>=</span> GetVertexNormalInputs(IN.normal);
</span></span><span style=display:flex><span>				
</span></span><span style=display:flex><span>				Varyings OUT;
</span></span><span style=display:flex><span>				OUT.positionWS <span style=color:#f92672>=</span> vertex_position_inputs.positionWS;
</span></span><span style=display:flex><span>			    OUT.normalWS <span style=color:#f92672>=</span> vertex_normal_inputs.normalWS;
</span></span><span style=display:flex><span>				OUT.positionCS <span style=color:#f92672>=</span> TransformWorldToHClip(ApplyShadowBias(OUT.positionWS,OUT.normalWS, _LightDirection));
</span></span><span style=display:flex><span>			    <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#66d9ef>if</span> UNITY_REVERSED_Z
</span></span><span style=display:flex><span>                    OUT.positionCS.z <span style=color:#f92672>=</span> min(OUT.positionCS.z, UNITY_NEAR_CLIP_VALUE);
</span></span><span style=display:flex><span>                <span style=color:#960050;background-color:#1e0010>#</span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                    OUT.positionCS.z <span style=color:#f92672>=</span> max(OUT.positionCS.z, UNITY_NEAR_CLIP_VALUE);
</span></span><span style=display:flex><span>                <span style=color:#960050;background-color:#1e0010>#</span>endif
</span></span><span style=display:flex><span>				OUT.uv <span style=color:#f92672>=</span> IN.uv;
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> OUT;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>half4</span> fragShadow(Varyings IN)<span style=color:#f92672>:</span>SV_TARGET
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			ENDHLSL
</span></span><span style=display:flex><span>		} 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=image-20230223220941154.png alt></p><hr><p>多光源阴影还有些问题，后面需要修一下bug。</p><h3 id=数学知识>数学知识</h3><p>某年某月某日的某个变态搞了个数学公式，用不等式来代替等式。
$$
\int_{\Omega} f(x) g(x) \mathrm{d} x \approx \frac{\int_{\Omega} f(x) \mathrm{d} x}{\int_{\Omega} \mathrm{d} x} \cdot \int_{\Omega} g(x) \mathrm{d} x
$$
使用例子：Rendering Equation
$$
L_{o}\left(p, \omega_{o}\right)=L_{e}\left(p, \omega_{o}\right)+\int_{\Omega^{+}} L_{i}\left(p, \omega_{i}\right) f_{r}\left(p, \omega_{i}, \omega_{o}\right) cos(\theta_i) V(p,\omega_{i}) \mathrm{d} \omega_{i}
$$
把Visibility拆出来：
$$
L_{o}\left(\mathrm{p}, \omega_{o}\right) \approx \frac{\int_{\Omega^{+}} V\left(\mathrm{p}, \omega_{i}\right) \mathrm{d} \omega_{i}}{\int_{\Omega^{+}} \mathrm{d} \omega_{i}} \cdot \int_{\Omega^{+}} L_{i}\left(\mathrm{p}, \omega_{i}\right) f_{r}\left(\mathrm{p}, \omega_{i}, \omega_{o}\right) \cos \theta_{i} \mathrm{~d} \omega_{i}
$$
因此其表示的意义就是,我们计算每个点的shading，然后去乘这个点的visibality得到的就是最后的渲染结果。</p><h2 id=pcf-软阴影>PCF 软阴影</h2><figure><img src=image-20230223221715111.png width=50%></figure><p>假设这是我们在shadow map中获取到的深度值，而P点得到的实际到光源深度为0.5，这时所有的在shadow map中获取到的深度值要与P点得到的实际到光源深度，即0.5进行比较，所有大于0.5的像素我们输出0，反之则输出</p><h2 id=pcss-软阴影>PCSS 软阴影</h2><ul><li><p>PCF 的思想，动态调整核的大小</p></li><li><p>什么地方需要硬阴影，什么地方需要硬阴影？</p></li><li><p>遮挡物和阴影的距离</p><ul><li>距离越大，阴影越软</li><li>距离越小，阴影越硬</li></ul><figure><img src=image-20210407175256445.png width=50%></figure></li><li><p>根据相似三角形</p><ul><li>penumbra：半影</li></ul><figure><img src=image-20230224103257763.png width=50%></figure></li></ul><h2 id=参考>参考</h2><ol><li><a href=https://zhuanlan.zhihu.com/p/523775521>https://zhuanlan.zhihu.com/p/523775521</a></li><li><a href=https://banbao991.github.io/2021/06/18/CG/Algorithm/SM-PCF-PCSS-VSM/>https://banbao991.github.io/2021/06/18/CG/Algorithm/SM-PCF-PCSS-VSM/</a></li><li><a href=https://www.cnblogs.com/KillerAery/p/15201310.html>https://www.cnblogs.com/KillerAery/p/15201310.html</a></li></ol></div><div class=post-text-bottom><div class=social-share data-title="Games 202 - 阴影" data-url=https://kampter.github.io/blog/games-202-%E9%98%B4%E5%BD%B1/><span>Share:</span>
<a class="share-btn share-btn-facebook share-btn-1" title="Share on Facebook"><i class="ion ion-social-facebook"></i></a>
<a class="share-btn share-btn-twitter share-btn-2" title="Share on Twitter"><i class="ion ion-social-twitter"></i></a>
<a class="share-btn share-btn-linkedin share-btn-3" title="Share on Linkedin"><i class="ion ion-social-linkedin"></i></a>
<a class="share-btn share-btn-reddit share-btn-4" title="Share on Reddit"><i class="ion ion-social-reddit"></i></a>
<a class="share-btn share-btn-pinterest share-btn-5" title="Share on Pinterest"><i class="ion ion-social-pinterest"></i></a></div><div class=tags-links>Tags:
<a href=https://kampter.github.io/tags/computer-graphic/ rel=tag>Computer Graphic</a>
<a href=https://kampter.github.io/tags/math/ rel=tag>Math</a>
<a href=https://kampter.github.io/tags/hlsl/ rel=tag>HLSL</a>
<a href=https://kampter.github.io/tags/unity/ rel=tag>Unity</a></div></div><div class=post-navigation role=navigation><div class=nav-previous><a href=https://kampter.github.io/blog/games-101-pbr%E5%8E%9F%E7%90%86/ rel=prev title="Games 101 - PBR原理"><span class="post-nav-next post-nav-text">Prev</span></a></div><div class=nav-next><a href=https://kampter.github.io/blog/%E5%86%9B%E5%9B%A2%E8%A6%81%E5%A1%9E2%E6%B8%B2%E6%9F%93shader%E5%AE%9E%E7%8E%B0/ rel=next title=军团要塞2渲染shader实现><span class="post-nav-prev post-nav-text">Next</span></a></div></div></div></div></div><div class=title>Comments</div><div class="row border-line-v"><div class="col col-m-12 col-t-12 col-d-12"><div class=post-box><div class=col-md-12><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://kampter.github.io/blog/games-202-%E9%98%B4%E5%BD%B1/",this.page.identifier="ee204b4398f0ef7746962ee6c3849abf"};(function(){var e=document,t=e.createElement("script");t.src="https://kampterblog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div></div></div></div></div></div></div><script src=https://kampter.github.io/plugins/jQuery/jquery.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js integrity="sha512-Nqw1tH3mpavka9cQCc5zWWEZNfIPdOYyQFjlV1NvflEtQ0/XI6ZQ+H/D3YgJdqSUJlMLAPRj/oXlaHCFbFCjoQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://kampter.github.io/plugins/search/simple-search.js></script>
<script src=https://kampter.github.io/plugins/validate/jquery.validate.min.js></script>
<script src=https://kampter.github.io/plugins/owl-carousel/owl.carousel.js></script>
<script src=https://kampter.github.io/plugins/magnific-popup/magnific-popup.min.js></script>
<script src=https://kampter.github.io/plugins/slimscroll/jquery.slimscroll.js></script>
<script src=https://kampter.github.io/plugins/imagesloaded/imagesloaded.pkgd.min.js></script>
<script src=https://kampter.github.io/plugins/isotope/isotope.pkgd.js></script>
<script src=https://kampter.github.io/plugins/typed/typed.js></script>
<script src=https://kampter.github.io/plugins/rrssb/rrssb.js></script>
<script src=https://kampter.github.io/js/form-handler.min.js></script>
<script src=https://kampter.github.io/js/common.min.js></script></body></html>