<!doctype html><html lang=en><head><title>尝试在URP下手写 PBR shader</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=HandheldFriendly content="true"><meta name=author content="bslthemes"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.8.0/css/all.css><link rel=stylesheet href=https://kampter.github.io/scss/style.min.css><link rel=stylesheet href=https://kampter.github.io/plugins/ionicons/ionicons.css><link rel=stylesheet href=https://kampter.github.io/plugins/font-awesome/css/font-awesome.css><link rel=stylesheet href=https://kampter.github.io/plugins/magnific-popup/magnific-popup.css><link rel=stylesheet href=https://kampter.github.io/plugins/owl-carousel/owl.carousel.css><link rel=stylesheet href=https://kampter.github.io/plugins/animate/animate.css><link rel=stylesheet href=https://kampter.github.io/plugins/syntax/syntax.css><link rel="shortcut icon" href=https://kampter.github.io/images/favicon/favicon.ico type=image/x-icon><link rel=icon href=https://kampter.github.io/images/favicon/favicon.ico type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-4BGKQYLBBG"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4BGKQYLBBG")</script></head><body class=blog><div class="page new-skin"><div class=preloader><div class="centrize full-width"><div class=vertical-center><div class=spinner><div class=double-bounce1></div><div class=double-bounce2></div></div></div></div></div><div class="background gradient"><ul class=bg-bubbles><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul></div><div class=s_overlay></div><div class=content-sidebar><div class=sidebar-wrap><aside id=secondary class=widget-area><div id=search class="widget widget_search"><form class=search-form action=https://kampter.github.io/search><label><input type=search id=searchInput class=search-field placeholder="Search ..."></label>
<input type=submit class=search-submit><ul id=searchResults></ul></form></div><section class="widget widget_menu"><h2 class=widget-title>Menu</h2><ul><li class=active><a href=https://kampter.github.io//blog>Blog Page</a></li><li><a href=https://kampter.github.io//portfolio>Portfolio Page</a></li></ul></section><section class="widget widget_recent_entries"><h2 class=widget-title>Latest Posts</h2><ul><li><a href=https://kampter.github.io/blog/%E8%BF%91%E6%9C%9F%E5%81%9A%E7%9A%84%E5%87%A0%E4%B8%AAunity%E5%92%8Cue%E7%89%B9%E6%95%88/>近期做的几个Unity和UE特效</a></li><li><a href=https://kampter.github.io/blog/urp%E5%B1%8F%E5%B9%95%E7%A9%BA%E9%97%B4sobel%E8%BE%B9%E7%BC%98%E6%A3%80%E6%B5%8B/>URP屏幕空间Sobel边缘检测</a></li><li><a href=https://kampter.github.io/blog/blender%E6%8F%92%E4%BB%B6%E5%88%B6%E4%BD%9C%E5%BF%83%E5%BE%97/>Blender插件制作心得</a></li><li><a href=https://kampter.github.io/blog/urp%E5%B1%8F%E5%B9%95%E7%A9%BA%E9%97%B4%E7%8E%AF%E5%A2%83%E5%85%89%E9%81%AE%E8%94%BD/>URP屏幕空间环境光遮蔽</a></li></ul></section><section class="widget widget_categories"><h2 class=widget-title>Categories</h2><ul><li><a href=https://kampter.github.io/categories/portfolio/>Portfolio</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>学习笔记</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/categories/%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/>技术实现</a>
<small>( 9 )</small></li><li><a href=https://kampter.github.io/categories/%E6%97%A5%E5%B8%B8%E7%94%9F%E6%B4%BB/>日常生活</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/>课程笔记</a>
<small>( 9 )</small></li></ul></section><section class="widget widget_tags"><h2 class=widget-title>Tags</h2><ul><li><a href=https://kampter.github.io/tags/after-effect/>After Effect</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/bifrost/>Bifrost</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/blender/>blender</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/c#/>C#</a>
<small>( 4 )</small></li><li><a href=https://kampter.github.io/tags/computer-graphic/>Computer Graphic</a>
<small>( 9 )</small></li><li><a href=https://kampter.github.io/tags/eve-online/>Eve Online</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/flip/>Flip</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/games-101/>Games 101</a>
<small>( 4 )</small></li><li><a href=https://kampter.github.io/tags/games-202/>Games 202</a>
<small>( 3 )</small></li><li><a href=https://kampter.github.io/tags/hlsl/>HLSL</a>
<small>( 11 )</small></li><li><a href=https://kampter.github.io/tags/houdini/>Houdini</a>
<small>( 3 )</small></li><li><a href=https://kampter.github.io/tags/java/>Java</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/math/>Math</a>
<small>( 8 )</small></li><li><a href=https://kampter.github.io/tags/maya/>Maya</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/niagara-system/>Niagara System</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/opengl/>Opengl</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/particle/>Particle</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/pbr-shading/>PBR Shading</a>
<small>( 2 )</small></li><li><a href=https://kampter.github.io/tags/plugin/>plugin</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/profiling/>Profiling</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/render-feature/>Render Feature</a>
<small>( 4 )</small></li><li><a href=https://kampter.github.io/tags/shader-graph/>Shader Graph</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/substance-designer/>Substance Designer</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/toon-shading/>Toon Shading</a>
<small>( 3 )</small></li><li><a href=https://kampter.github.io/tags/unity/>Unity</a>
<small>( 12 )</small></li><li><a href=https://kampter.github.io/tags/unreal-engine/>Unreal Engine</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/upr/>UPR</a>
<small>( 1 )</small></li><li><a href=https://kampter.github.io/tags/vfx-graph/>VFX graph</a>
<small>( 1 )</small></li></ul></section></aside></div><span class=close></span></div><div class="container opened" data-animation-in=fadeInLeft data-animation-out=fadeOutLeft><header class=header><a href=# class=menu-btn><span></span></a><div class=top-menu><ul><li class=active><a href=https://kampter.github.io/#about-card><span class="icon ion-person"></span>
<span class=link>About</span></a></li><li><a href=https://kampter.github.io/#resume-card><span class="icon ion-android-list"></span>
<span class=link>Resume</span></a></li><li><a href=https://kampter.github.io/#works-card><span class="icon ion-paintbrush"></span>
<span class=link>Works</span></a></li><li><a href=https://kampter.github.io/#blog-card><span class="icon ion-chatbox-working"></span>
<span class=link>Blog</span></a></li><li><a href=https://kampter.github.io/#contact-card><span class="icon ion-at"></span>
<span class=link>Contact</span></a></li></ul></div></header><div class=card-started id=home-card><div class="profile no-photo"><div class=slide style=background-image:url(https://kampter.github.io/images/1082264.png)></div><div class=title>王子正</div><div class="subtitle subtitle-typed"><div class=typing-title><p>Technical Artist</p></div></div><div class=social><a target=_blank href=https://twitter.com/wang_psbswsg title=Twitter><span class="fab fa-twitter"></span></a>
<a target=_blank href=https://github.com/Kampter title=GitHub><span class="fab fa-github"></span></a>
<a target=_blank href=https://www.youtube.com/channel/UCK43eUkmsyRk8FeBw5oRJtQ title=Youtube><span class="fab fa-youtube"></span></a>
<a target=_blank href=https://www.artstation.com/kampter title=Stackoverflow><span class="fab fa-artstation"></span></a></div><div class=lnks><a href=/images/Resume_ZizhengWang_Chinese_v004.pdf target=_blank class=lnk><span class=text>Download CV</span>
<span class="ion ion ion-archive"></span></a>
<a href=mailto:psbswsg@gmail.com target=_blank class=lnk><span class=text>Contact Me</span>
<span class="ion arrow"></span></a></div></div></div><div class="card-inner blog blog-post animated" id=blog-card><div class=card-wrap><div class="content blog-single"><div class=title>Blog Post</div><div class="row border-line-v"><div class="col col-m-12 col-t-12 col-d-12"><div class=post-box><h1>尝试在URP下手写 PBR shader</h1><div class=blog-detail><span class=date>February 10, 2023</span>
<span class=cat-links><a href=https://kampter.github.io/categories/%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0/>技术实现</a></span>
<span class=byline>By <span class=author>Ryan Adlard</span></span></div><div class=blog-image><img src=https://kampter.github.io/images/blog/image-20230214155911531.png alt="尝试在URP下手写 PBR shader"></div><div class=blog-content><h2 id=cook-torrance-brdf>Cook-Torrance BRDF</h2><p>Cook-Torrance BRDF的镜面反射部分包含三个函数，此外分母部分还有一个标准化因子 。字母D，F与G分别代表着一种类型的函数，各个函数分别用来近似的计算出表面反射特性的一个特定部分。三个函数分别为法线分布函数(Normal <strong>D</strong>istribution Function)，菲涅尔方程(<strong>F</strong>resnel Rquation)和几何函数(<strong>G</strong>eometry Function)：</p><ul><li><p>D项 - <strong>法线分布函数</strong>: 估算在受到表面粗糙度的影响下，朝向方向与半程向量一致的微平面的数量。这是用来估算微平面的主要函数。</p><p><img src=image-20230213152113538.png alt=image-20230213152113538></p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#66d9ef>half</span> Function_D(<span style=color:#66d9ef>half</span> ndotH, <span style=color:#66d9ef>half</span> roughness)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half</span> a2 <span style=color:#f92672>=</span> roughness <span style=color:#f92672>*</span> roughness;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half</span> ndotH2 <span style=color:#f92672>=</span> ndotH <span style=color:#f92672>*</span> ndotH;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half</span> nom <span style=color:#f92672>=</span> a2;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half</span> denom <span style=color:#f92672>=</span> (ndotH2 <span style=color:#f92672>*</span> (a2 <span style=color:#f92672>-</span> <span style=color:#ae81ff>1.0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1.0</span>);
</span></span><span style=display:flex><span>    denom <span style=color:#f92672>=</span> PI <span style=color:#f92672>*</span> denom <span style=color:#f92672>*</span> denom;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> nom<span style=color:#f92672>/</span>denom;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=image-20230213152220206.png alt></p><hr><ul><li><p>G项 - <strong>几何函数</strong>：</p></li><li><p>几何函数从统计学上近似的求得了微平面间相互遮蔽的比率，这种相互遮蔽会损耗光线的能量。</p><p><img src=geometry_shadowing.png alt></p><p><img src=image-20230213152316678.png alt></p></li></ul><p>为了有效的估算几何部分，需要将观察方向（几何遮蔽(Geometry Obstruction)）和光线方向向量（几何阴影(Geometry Shadowing)）都考虑进去。我们可以使用史密斯法(Smith’s method)来把两者都纳入其中(第二次计算把v换成l)：</p><p><img src=image-20230213152658568.png alt></p><p>这里的k是α的重映射(Remapping)，取决于我们要用的是针对直接光照还是针对IBL光照的几何函数:</p><p><img src=image-20230213153404416.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#66d9ef>half</span> GeometrySchlickGGX(<span style=color:#66d9ef>half</span> ndotV, <span style=color:#66d9ef>half</span> k)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> nom   <span style=color:#f92672>=</span> ndotV;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> denom <span style=color:#f92672>=</span> ndotV <span style=color:#f92672>*</span> (<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> k) <span style=color:#f92672>+</span> k;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> nom <span style=color:#f92672>/</span> denom;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> GeometrySmith(<span style=color:#66d9ef>half</span> ndotV, <span style=color:#66d9ef>half</span> ndotL, <span style=color:#66d9ef>half</span> k)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> ggx1 <span style=color:#f92672>=</span> GeometrySchlickGGX(ndotV, k);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>float</span> ggx2 <span style=color:#f92672>=</span> GeometrySchlickGGX(ndotL, k);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ggx1 <span style=color:#f92672>*</span> ggx2;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> Function_G(<span style=color:#66d9ef>half</span> ndotV, <span style=color:#66d9ef>half</span> ndotL, <span style=color:#66d9ef>half</span> k)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> GeometrySmith(ndotV, ndotL, k);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=image-20230213153857894.png alt></p><hr><ul><li>F项 - <strong>菲涅尔方程</strong>：菲涅尔方程描述的是在不同的表面角下表面所反射的光线所占的比率。</li></ul><p>菲涅尔方程是一个相当复杂的方程式，不过幸运的是菲涅尔方程可以用Fresnel-Schlick近似法求得近似解：</p><p><img src=image-20230213154235656.png alt></p><p>F0表示平面的基础反射率，它是利用所谓<strong>折射指数</strong>(Indices of Refraction)或者说IOR计算得出的。然后正如你可以从球体表面看到的那样，我们越是朝球面掠角的方向上看（此时视线和表面法线的夹角接近90度）菲涅尔现象就越明显，反光就越强：</p><p><img src=fresnel.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#75715e>// calculate F0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> Calculate_F0(<span style=color:#66d9ef>half3</span> albedo, <span style=color:#66d9ef>half</span> metalness)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half3</span> F0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.04</span>;
</span></span><span style=display:flex><span>    F0 <span style=color:#f92672>=</span> lerp(F0, albedo, metalness);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> F0;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> Function_F(<span style=color:#66d9ef>half</span> ndotV, <span style=color:#66d9ef>half3</span> albedo, <span style=color:#66d9ef>half</span> metalness)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half3</span> F0 <span style=color:#f92672>=</span> Calculate_F0(albedo, metalness);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> F0 <span style=color:#f92672>+</span> (<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> F0) <span style=color:#f92672>*</span> pow(<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> ndotV, <span style=color:#ae81ff>5.0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=image-20230213155609967.png alt></p><hr><p>这里的kd是早先提到过的入射光线中<strong>被折射</strong>部分的能量所占的比率，而ks是<strong>被反射</strong>部分的比率。BRDF的左侧表示的是漫反射部分，它被称为Lambertian漫反射，这和我们之前在漫反射着色中使用的常数因子类似，用如下的公式来表示：</p><p><img src=image-20230213151542786.png alt></p><p><img src=image-20230213173303675.png alt></p><hr><p>BRDF的镜面反射部分要稍微更高级一些，它的形式如下所示：</p><p><img src=image-20230213150548688.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#75715e>// direct specular</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> smoothness <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> roughness <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span> smoothness;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> functionD <span style=color:#f92672>=</span> Function_D(ndotH, roughness);
</span></span><span style=display:flex><span><span style=color:#75715e>// remap roughness to k value</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> kDirect <span style=color:#f92672>=</span> pow(roughness <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> direct_functionG <span style=color:#f92672>=</span> Function_G(ndotV, ndotL, kDirect);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> functionF <span style=color:#f92672>=</span> Function_F(ndotV, albedo, metalness);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> nominator <span style=color:#f92672>=</span> functionD <span style=color:#f92672>*</span> direct_functionG <span style=color:#f92672>*</span> functionF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> demoninator <span style=color:#f92672>=</span> <span style=color:#ae81ff>4.0</span> <span style=color:#f92672>*</span> ndotV <span style=color:#f92672>*</span> ndotL <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.001</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> specular <span style=color:#f92672>=</span> nominator <span style=color:#f92672>/</span> demoninator;
</span></span></code></pre></div><p><img src=image-20230213170817796.png alt></p><hr><p>实时渲染中几乎只能使用Cook-Torrance BRDF模型。BRDF同时描绘入射光线和出射光线。严格上来说，Blinn-Phong光照模型也被认为是一个BRDF。然而由于Blinn-Phong模型并没有遵循能量守恒定律，因此它不被认为是基于物理的渲染。BRDF兼有漫反射和镜面反射两个部分：</p><p><img src=image-20230213151433065.png alt></p><p>最终渲染方程：</p><p><img src=image-20230213181607650.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#75715e>// Direct BRDF = Lambertian + Direct Specular</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// direct specular</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> smoothness <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> roughness <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span> smoothness;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> functionD <span style=color:#f92672>=</span> Function_D(ndotH, roughness);
</span></span><span style=display:flex><span><span style=color:#75715e>// remap roughness to k value</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> kDirect <span style=color:#f92672>=</span> pow(roughness <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> direct_functionG <span style=color:#f92672>=</span> Function_G(ndotV, ndotL, kDirect);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> functionF <span style=color:#f92672>=</span> Function_F(ndotV, albedo, metalness);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> nominator <span style=color:#f92672>=</span> functionD <span style=color:#f92672>*</span> direct_functionG <span style=color:#f92672>*</span> functionF;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> demoninator <span style=color:#f92672>=</span> <span style=color:#ae81ff>4.0</span> <span style=color:#f92672>*</span> ndotV <span style=color:#f92672>*</span> ndotL <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.001</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> specular <span style=color:#f92672>=</span> nominator <span style=color:#f92672>/</span> demoninator;
</span></span><span style=display:flex><span><span style=color:#75715e>// Lambertian</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> kS <span style=color:#f92672>=</span> functionF; 
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> kD <span style=color:#f92672>=</span> <span style=color:#66d9ef>half3</span>(<span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>, <span style=color:#ae81ff>1.0</span>) <span style=color:#f92672>-</span> kS;
</span></span><span style=display:flex><span>kD <span style=color:#f92672>*=</span> <span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> metalness;
</span></span><span style=display:flex><span><span style=color:#75715e>// Render Equation</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> radiance <span style=color:#f92672>=</span> mainLightColor <span style=color:#f92672>*</span> mainLightAtten;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> Lo <span style=color:#f92672>=</span> (kD <span style=color:#f92672>*</span> albedo <span style=color:#f92672>/</span> PI <span style=color:#f92672>+</span> kS <span style=color:#f92672>*</span> specular) <span style=color:#f92672>*</span> radiance <span style=color:#f92672>*</span> ndotL <span style=color:#f92672>*</span> AO;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> directColor <span style=color:#f92672>=</span> ambient <span style=color:#f92672>+</span> Lo;
</span></span></code></pre></div><p><img src=image-20230213174223729.png alt></p><hr><h2 id=image-based-lighting>Image based lighting</h2><p>IBL 通常使用（取自现实世界或从3D场景生成的）环境立方体贴图 (Cubemap) ，我们可以将立方体贴图的每个像素视为光源，在渲染方程中直接使用它。这种方式可以有效地捕捉环境的全局光照和氛围，使物体<strong>更好地融入</strong>其环境。</p><p>由于基于图像的光照算法会捕捉部分甚至全部的环境光照，通常认为它是一种更精确的环境光照输入格式，甚至也可以说是一种全局光照的粗略近似。基于此特性，IBL 对 PBR 很有意义，因为当我们将环境光纳入计算之后，物体在物理方面看起来会更加准确。</p><h2 id=间接diffuse>间接Diffuse</h2><p>仔细观察漫反射积分，我们发现漫反射兰伯特项是一个常数项（颜色 c 、折射率 kd 和 π 在整个积分是常数），不依赖于任何积分变量。基于此，我们可以将常数项移出漫反射积分：</p><p><img src=image-20230215164305301.png alt></p><p>这边没有直接参考公式手写轮子，而是摘抄Unity在SphericalHarmonics.hlsl中的实现代码，原理相同，都是对环境光cubemap进行采样。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span>real3 SH_indirectDiffuse(real3 normalWS, real AO)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    real4 SHCoefficients[<span style=color:#ae81ff>7</span>];
</span></span><span style=display:flex><span>    SHCoefficients[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> unity_SHAr;
</span></span><span style=display:flex><span>    SHCoefficients[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> unity_SHAg;
</span></span><span style=display:flex><span>    SHCoefficients[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> unity_SHAb;
</span></span><span style=display:flex><span>    SHCoefficients[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>=</span> unity_SHBr;
</span></span><span style=display:flex><span>    SHCoefficients[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> unity_SHBg;
</span></span><span style=display:flex><span>    SHCoefficients[<span style=color:#ae81ff>5</span>] <span style=color:#f92672>=</span> unity_SHBb;
</span></span><span style=display:flex><span>    SHCoefficients[<span style=color:#ae81ff>6</span>] <span style=color:#f92672>=</span> unity_SHC;
</span></span><span style=display:flex><span>    real3 color <span style=color:#f92672>=</span> SampleSH9(SHCoefficients, normalWS);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> max(<span style=color:#ae81ff>0</span>, color) <span style=color:#f92672>*</span> AO;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=image-20230213200733080.png alt></p><hr><h2 id=间接specular>间接Specular</h2><p>间接高光部分的代码分别参考ImageBasedLighting.hlsl, EntityLighing.hlsl, GlobalIllumination.hlsl的代码实现，用了比较偷懒的方式而不是完全手写。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#66d9ef>half3</span> IndirectSpecular(<span style=color:#66d9ef>half</span> reflectVector, <span style=color:#66d9ef>half</span> roughness, <span style=color:#66d9ef>half</span> AO)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half</span> mip <span style=color:#f92672>=</span> PerceptualRoughnessToMipmapLevel(roughness);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half4</span> encodedIrradiance <span style=color:#f92672>=</span> <span style=color:#66d9ef>half4</span>(SAMPLE_TEXTURECUBE_LOD(unity_SpecCube0, samplerunity_SpecCube0, reflectVector, mip));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half3</span> irradiance <span style=color:#f92672>=</span> DecodeHDREnvironment(encodedIrradiance, unity_SpecCube0_HDR);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> irradiance <span style=color:#f92672>*</span> AO;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Indirect Function F</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> EnvironmentBRDFSpecular(<span style=color:#66d9ef>half</span> roughness, <span style=color:#66d9ef>half3</span> specular, <span style=color:#66d9ef>half</span> fresnelTerm, <span style=color:#66d9ef>half</span> grazingTerm)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>half</span> surfaceReduction <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.0</span> <span style=color:#f92672>/</span> (roughness <span style=color:#f92672>*</span> roughness <span style=color:#f92672>+</span> <span style=color:#ae81ff>1.0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>half3</span>(surfaceReduction <span style=color:#f92672>*</span> lerp(specular, grazingTerm, fresnelTerm));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=image-20230214143652274.png alt></p><hr><p>合并效果</p><p>最终结果 = 直接光漫反射 + 直接光镜面反射 + 间接光漫反射 + 间接光镜面反射</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#f92672>/</span> Indirect BRDF
</span></span><span style=display:flex><span><span style=color:#75715e>// Indirect diffuse</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> indirectDiffuse <span style=color:#f92672>=</span> SH_indirectDiffuse(normalWS, AO);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> indirectColor <span style=color:#f92672>=</span> indirectDiffuse <span style=color:#f92672>*</span> albedo;
</span></span><span style=display:flex><span><span style=color:#75715e>// Indirect Specualr</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> NoV <span style=color:#f92672>=</span> saturate(dot(normalWS, viewDirWS));
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> fresnelTerm <span style=color:#f92672>=</span> Pow4(<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> NoV);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> oneMinusReflectivity <span style=color:#f92672>=</span> OneMinusReflectivityMetallic(metalness);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> reflectivity <span style=color:#f92672>=</span> <span style=color:#66d9ef>half</span>(<span style=color:#ae81ff>1.0</span>) <span style=color:#f92672>-</span> oneMinusReflectivity;
</span></span><span style=display:flex><span><span style=color:#66d9ef>half</span> grazingTerm <span style=color:#f92672>=</span> saturate(reflectivity <span style=color:#f92672>+</span> smoothness);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> indirectSpecular <span style=color:#f92672>=</span> IndirectSpecular(reflectVector, roughness, AO);
</span></span><span style=display:flex><span><span style=color:#66d9ef>half3</span> brdfSpecular <span style=color:#f92672>=</span> Calculate_F0(albedo, metalness);
</span></span><span style=display:flex><span>indirectColor <span style=color:#f92672>+=</span> AO <span style=color:#f92672>*</span> indirectSpecular <span style=color:#f92672>*</span> EnvironmentBRDFSpecular(roughness, brdfSpecular, fresnelTerm, grazingTerm);
</span></span></code></pre></div><p>最后添加脸部和手部的emission fake SSS效果，最终合成效果如下</p><p><img src=image-20230214155911531.png alt></p><hr><h2 id=参考>参考</h2><ol><li><a href=https://www.bilibili.com/read/cv7510082>URP管线的自学HLSL之路 第三十七篇 造一个PBR的轮子 - 哔哩哔哩 (bilibili.com)</a></li><li><a href=https://blog.csdn.net/linjf520/article/details/122464903>Unity Shader - 搬砖日志 - URP PBR (抄作业篇，持续更新~)_Jave.Lin的博客-CSDN博客_unity urp的pbrshader</a></li><li>[理论 - LearnOpenGL CN (learnopengl-cn.github.io)](<a href=https://learnopengl-cn.github.io/07>https://learnopengl-cn.github.io/07</a> PBR/01 Theory/)</li><li><a href=https://zhuanlan.zhihu.com/p/371395846>URP管线PBR源码剖析（上） - 知乎 (zhihu.com)</a></li></ol></div><div class=post-text-bottom><div class=social-share data-title="尝试在URP下手写 PBR shader" data-url=https://kampter.github.io/blog/%E5%B0%9D%E8%AF%95%E5%9C%A8urp%E4%B8%AD%E6%89%8B%E5%86%99-pbr-shader/><span>Share:</span>
<a class="share-btn share-btn-facebook share-btn-1" title="Share on Facebook"><i class="ion ion-social-facebook"></i></a>
<a class="share-btn share-btn-twitter share-btn-2" title="Share on Twitter"><i class="ion ion-social-twitter"></i></a>
<a class="share-btn share-btn-linkedin share-btn-3" title="Share on Linkedin"><i class="ion ion-social-linkedin"></i></a>
<a class="share-btn share-btn-reddit share-btn-4" title="Share on Reddit"><i class="ion ion-social-reddit"></i></a>
<a class="share-btn share-btn-pinterest share-btn-5" title="Share on Pinterest"><i class="ion ion-social-pinterest"></i></a></div><div class=tags-links>Tags:
<a href=https://kampter.github.io/tags/pbr-shading/ rel=tag>PBR Shading</a>
<a href=https://kampter.github.io/tags/unity/ rel=tag>Unity</a>
<a href=https://kampter.github.io/tags/hlsl/ rel=tag>HLSL</a></div></div><div class=post-navigation role=navigation><div class=nav-previous><a href=https://kampter.github.io/blog/urp%E4%BB%BF%E5%8E%9F%E7%A5%9E%E6%B8%B2%E6%9F%93shader/ rel=prev title=URP仿原神渲染shader><span class="post-nav-next post-nav-text">Prev</span></a></div><div class=nav-next><a href=https://kampter.github.io/blog/global-game-jam-2023%E5%9B%9E%E9%A1%BE/ rel=next title="GGJ2023 x GiCA 中国站回顾"><span class="post-nav-prev post-nav-text">Next</span></a></div></div></div></div></div><div class=title>Comments</div><div class="row border-line-v"><div class="col col-m-12 col-t-12 col-d-12"><div class=post-box><div class=col-md-12><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://kampter.github.io/blog/%E5%B0%9D%E8%AF%95%E5%9C%A8urp%E4%B8%AD%E6%89%8B%E5%86%99-pbr-shader/",this.page.identifier="282a0606a99f08c69c1f6bb16ac3ec57"};(function(){var e=document,t=e.createElement("script");t.src="https://kampterblog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div></div></div></div></div></div></div><script src=https://kampter.github.io/plugins/jQuery/jquery.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js integrity="sha512-Nqw1tH3mpavka9cQCc5zWWEZNfIPdOYyQFjlV1NvflEtQ0/XI6ZQ+H/D3YgJdqSUJlMLAPRj/oXlaHCFbFCjoQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://kampter.github.io/plugins/search/simple-search.js></script>
<script src=https://kampter.github.io/plugins/validate/jquery.validate.min.js></script>
<script src=https://kampter.github.io/plugins/owl-carousel/owl.carousel.js></script>
<script src=https://kampter.github.io/plugins/magnific-popup/magnific-popup.min.js></script>
<script src=https://kampter.github.io/plugins/slimscroll/jquery.slimscroll.js></script>
<script src=https://kampter.github.io/plugins/imagesloaded/imagesloaded.pkgd.min.js></script>
<script src=https://kampter.github.io/plugins/isotope/isotope.pkgd.js></script>
<script src=https://kampter.github.io/plugins/typed/typed.js></script>
<script src=https://kampter.github.io/plugins/rrssb/rrssb.js></script>
<script src=https://kampter.github.io/js/form-handler.min.js></script>
<script src=https://kampter.github.io/js/common.min.js></script></body></html>